{% extends 'base.html' %}
{% set device_type_names = {
  'tidbyt_gen1': 'Tidbyt Gen1',
  'tidbyt_gen2': 'Tidbyt Gen2',
  'pixoticker': 'Pixoticker',
  'tronbyt_s3': 'Tronbyt S3',
  'tronbyt_s3_wide': 'Tronbyt S3 Wide',
  'raspberrypi': 'Raspberry Pi',
  'other': 'Other'
} %}
{% block header %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/firmware.css') }}">
<h1>{% block title %}{{ _('Generate Firmware for') }} {{ device['name'] }} - {{ device_type_names.get(device['type'], device['type']) }}{% endblock %}</h1>
{% endblock %}
{% block content %}
{% if firmware_version %}
<div class="firmware-info">
    <div>
        <strong>{{ _('Firmware Image Version') }}:</strong> {{ firmware_version }}
    </div>
    {% if g.user.username == 'admin' %}
    <div>
        <a href="{{ url_for('auth.edit') }}#firmware-management" class="w3-button w3-small w3-gray firmware-management-btn">
            {{ _('Manage Firmware') }}
        </a>
    </div>
    {% endif %}
</div>
{% endif %}

<form method="post">
    <h2>{{ _('Download ESP Flasher here') }} <a href="https://github.com/Jason2866/ESP_Flasher/releases">ESP Flasher</a></h2>
    {{ _('Connect your device to your computer with a data USB cable, run the ESP Flasher program and select your
    downloaded firmware file to flash your device. Do NOT use a web based flasher.') }}
    <br><i>{{ _('macOS and Windows users may need to install a serial driver:') }}
        <br>
        <a href="https://www.silabs.com/developer-tools/usb-to-uart-bridge-vcp-drivers?tab=downloads">CP210x Drivers</a>
        <br>
        <a href="https://github.com/WCHSoftGroup/ch34xser_macos">CH34x Drivers</a>
    </i>
    <br>
    <input type="hidden" name="id" id="id" value="{{ device['id'] }}">

    <div class="connection-type-container">
        <label>{{ _('Connection Type') }}:</label>
        <label><input type="radio" name="url_variant" id="variant_http" value="http">
            HTTP</label>
        <label><input type="radio" name="url_variant" id="variant_ws" value="ws">
            WebSocket</label>
        <label><input type="radio" name="url_variant" id="variant_custom" value="custom"> Custom</label>
    </div>

    <div class="url-input-container">
        <label for="img_url">{{ _('Image URL') }}</label>
        <input name="img_url" id="img_url" value="{{ device['img_url'] }}">
    </div>

    <div class="wifi-input-container">
        <label for="wifi_ap">{{ _('WiFi Network Name (SSID) 2.4Ghz Only') }}</label>
        <input name="wifi_ap" id="wifi_ap" required>
    </div>
    <div class="wifi-input-container">
        <label for="wifi_password">{{ _('WiFi Password') }}</label>
        <input name="wifi_password" id="wifi_password" required>
    </div>

    {% if device.get('type') == 'tidbyt_gen1' %}
    <div class="swap-colors-container">
        <label for="swap_colors">{{ _('Swap Colors?') }}</label>
        <input type="checkbox" name="swap_colors" id="swap_colors" {% if request.form.get('swap_colors') %} checked {%
            endif %}>
    </div>
    {% endif %}
    <input class="w3-button w3-blue" type="submit" value="{{ _('Generate Firmware File') }}">
</form>
<hr>

<script>
    (function () {
        const input = document.getElementById('img_url');
        const httpRadio = document.getElementById('variant_http');
        const wsRadio = document.getElementById('variant_ws');
        const customRadio = document.getElementById('variant_custom');
        const httpVal = "{{ device['img_url'] }}";
        const wsVal = "{{ device['ws_url'] }}";

        function updateUrl() {
            if (httpRadio.checked || wsRadio.checked) {
                input.value = httpRadio.checked ? httpVal : wsVal;
                input.readOnly = true;
            } else if (customRadio.checked) {
                input.value = "";
                input.readOnly = false;
            }
        }

        document.querySelectorAll('input[name="url_variant"]').forEach(radio => {
            radio.addEventListener('change', updateUrl);
        });

        // Initialize
        httpRadio.checked = true;
        updateUrl();
    })();
</script>

{% endblock %}